dracut 生成 initramfs 镜像的低级工具

dracut [OPTION] [<image> [<kernel version>]]

创建一个以 <image> 命名 对应 系统内核版本为 <kernel version> 的 initramfs 文件
如果 <kernel version> 未指定，则以当前正在使用的系统内核为准
如果 <image> 未指定，则使用 /boot/initramfs-<kernel version>.img

需要寻找完整的 内核命令选项 可以 man 7 dracut.cmdline

若已救援模式启动，则所有的与 initramfs 相关的 log 都会保存至 /run/initramfs/rdsosreport.txt 中


# 常用的选项搭配

dracut
	以当前运行状态，配制出 initramfs 文件

dracut foobar.img
	自定义 initramfs 文件名

dracut foobar.img 3.10.0-229.el7.x86_64
	自定义 intiramfs 文件名 和使用的 系统内核

dracut --kver 3.10.0-229.el7.x86_64
	仅自定义 使用的 系统内核

若要最精简化 initramfs，可以使用 --hostonly 或 -H 命令
这样 dracut 会生成 本机 以 当前状态 启动，所需要的最少的文件
从 CentOS 7 开始，这将成为默认的设置，
若要生成 non-hostonly image，请安装 dracut-config-generic rpm 包

若要查看一个 initramfs 包，请使用 lsinitrd 命令

若要启用 dracut 模块，可以将 模块名添加至
/etc/dracut.conf
或
/etc/dracut.conf.d/<name>.conf
详见 man 5 dracut.conf
或使用 --add 或 -a 参数
dracut --add bootchart initramfs-bootchart.img

dracut --list-modules
	查看可用的 dracut 模块

关闭 dracut 模块
	将模块名添加至 dracut.conf 或 /etc/dracut.d/<name>.conf 的 omit_dracutmodules 变量中
	或使用 --omit 或 -o 参数
	dracut -o "multipath lvm" no-multipath-lvm.img

添加 kernel 模块
	使用 --add-drivers 选项
	或将模块名添加至 dracut.conf 或 /etc/dracut.d/<name>.conf 的 drivers 变量中
	dracut --add-drivers mymod initramfs-with-mymod.img

对于未使用 hostonly 模式生成的 initramfs，其中不会包含任何系统配置文件
而系统配置信息，将以 内核命令 的方式传递给 内核
而 内核命令 将写入 grub.cfg 配置文件中
若要取得 内核命令 中必须指定的磁盘路径，可以使用以下命令
dracut --print-cmdline

内核命令 的 root 指定
	系统更目录所在位置 可以用 root=<设备路径> EG. root=/dev/sda
					  可以用 root=UUID=<设备 UUID> EG. root=UUID=19e9dda3-5a38-484d-a9b0-fa6b067d0331
					  可以用 root=LABEL=<设备 label> EG. root=label=MyRootPartiLabel

若使用了加密磁盘作为启动目录，则可以配置 输入密码时 需要的 字体、键盘映射样式、以及语言 等等
	EG.
	rd.vconsole.font=latarcyrheb-sun16 rd.vconsole.keymap=de-latin1-nodeadkeys rd.locale.LANG=de_DE.UTF-819e9dda3-5a38-484d-a9b0-fa6b067d0331

禁用 内核模块
	EG.
	rd.driver.blacklist=mptsas rd.driver.blaclist=nouveau

加速启动进程
	EG. 若系统根目录不在 LVM RAID 或 LUKS 加密盘上，则可以在 内核命令上添加如下参数
	rd.luks=0 rd.lvm=0 rd.dm=0
	这会让内核不加载 LUKS LVM 和 RAID 支持模块，加速启动

在 intiramfs 中加入自定义文件
	使用 --include 选项，该选项只能定义一次
	dracut --include <原文件/目录> <目标路径> <initramfs 文件名>
	使用 --install 选项，该选项可定义多次
	dracut --install "strace fsck.ext3 ssh" initramfs-dbg.img

若要使用网络设备作为 根目录，则需要安装 dracut-network 程序
详见 Red Hat Enterprise Linux Storage Administration Guide

最小化 镜像 大小
	<1> 禁用所有开机时不需要的 dracut 模块
		用 -m 指定需要的 dracut 模块
	<2> 使用 --host-only 仅加载启动需要的 kernel 模块
	EG.
	# 对于一个 NFS 镜像
	dracut -m "nfs network base" initramfs-nfs-only.img
	# 接着在目标机器上用该镜像启动，并执行
	dracut -m "nfs network base" --host-only initramfs-nfs-hostonly.img
	# 这样就极大的减小了 镜像 的 大小
