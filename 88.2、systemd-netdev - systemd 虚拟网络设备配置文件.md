# systemd.netdev

## 名称

systemd.netdev — 虚拟网络设备配置

## 概要

*netdev*`.netdev`

## 描述

网络是通过 *systemd-networkd(8)* 进行配置的。

主虚拟网络设备文件必须具有后缀名 `.netdev`；其他后缀将被忽略。虚拟网络设备在 **networkd** 启动时就被创建。若存在已有的虚拟网络设备名称，则 **networkd** 将继续使用该名称，而非创建一个新的。注意，已经存在的 netdev 的设置不会被 **networkd** 修改。

`.netdev` 文件从系统网络文件夹中读取，包含 `/usr/lib/systemd/network`， `/usr/local/lib/systemd/network`，易失性运行时网络文件夹 `/run/systemd/network`，以及本地管理员网络文件夹 `/etc/systemd/network`。所有配置文件均以字符方式排序并处理，无关它们存在与哪个目录中。但是，具有完全相同的文件名的文件将相互替换。在 `/etc/` 中的文件具有最高优先级，`/run` 中的其次，`/usr` 下的优先级最低。这样系统提供的文件就可以按需被本地文件替换。在特殊形况下，一个空文件（文件大小为 0）或指向 `/dev/null` 的软链接将完全禁用该配置文件（也就是被 “masked”）。

在 netdev 文件 `foo.netdev` 目录下，可以存在名为 `foo.netdev.d/` 的 “插入” 目录。该目录下所有以 `.conf` 结尾的文件都会在主文件解析之后被解析。这有助于修改或添加配置，而不需要修改主配置文件。每个插入文件必须具有合适的段头部（section header）。

除了 `/etc/systemd/network`，插入文件夹 `.d` 也可以被放置在 `/usr/lib/systemd/network` 以及 `/run/systemd/network` 目录下。`/etc` 下的插入文件优先于 `/run`，`/run` 下的文件优先于 `/usr/lib`。插入文件优先于高于对应的主 netdev 文件。（当然，由于 `/run` 文件夹是临时的，而 `/usr/lib` 是厂商的，所以插入文件夹不太应该出现在这些位置）。

## 支持的 netdev 类型

可以在 `.netdev` 文件中配置下列虚拟网络设备类型：

### 支持的虚拟网络设备类型

- bond 绑定

    一个绑定设备为它的从设备的聚合。参见 [*Linux Ethernet Bonding Driver HOWTO*](https://www.kernel.org/doc/Documentation/networking/bonding.txt) 了解详情。

- bridge 网桥

    网桥设备为软件交换机，它的每个从设备和桥接自身均为交换机的端口

- dummy 呆设备

    一个呆设备会丢弃所有发送给它的包。

- gre - Generic Routing Encapsulation - 通用路由封装

    IPv4 承载的 3 层 GRE 隧道。参见 *RFC 2784* 了解详情。

- gretap

    IPv4 承载的 2 层 GRE 隧道。

- erspan - Encapsulated Remote Switched Port Analyzer

    ERSPAN 从一个或多个源端口镜像流量，并将流量发送至给另一个交换机的一个或多个目标端口。  
    流量通过 GRE 封装，因此流量可以通过三层网络在源交换机和目标交换机之间路由。

- ip6gre

    IPv6 承载的三层 GRE 隧道。

- ip6tnl

    IPv6 承载的 IPv4 或 IPv6 隧道。

- ip6gretap

    IPv6 承载的二层 GRE 隧道。

- ipip

    IPv4 承载的 IPv4 隧道。

- ipvlan

    ipvlan 设备为一个层叠（stacked）设备，它基于 IP 地址过滤 从底层设备接收网络包。

- ipvtap

    ipvtag 设备为一个层叠（stacked）设备，它基于 IP 地址过滤 从底层设备接收网络包，并可以通过 tap 用户空间界面存取内容。

- macvlan

    macvlan 设备为一个层叠（stacked）设备，它基于 MAC 地址过滤 从底层设备接收网络包。

- macvtap

    macvtap 设备为一个层叠（stacked）设备，它基于 MAC 地址过滤 从底层设备接收网络包。

- sit

    IPv4 承载的 IPv6 隧道。

- tap - Terminal Access Point

    永久的一个网络设备和一个设备节点之间的二层隧道。

- tun

    永久的一个网络设备和一个设备节点之间的三层隧道。

- veth

    一对网络设备之间的以太网隧道。

- vlan

    VLAN 是一个层叠设备，它基于 VLAN 标签从底层设备接收网络包。参见 *IEEE 802.1Q* 了解详情。

- vti
    IPSec 承载的 IPv4 隧道。

- vti6

    IPSec 承载的 IPv6 隧道。

- vxlan

    虚拟可扩展局域网（virtual extensible LAN（vxlan）），用于连接云端计算部署。

- geneve

    通用网络虚拟化封装（GEneric NEtwork Virtualization Encapsulation（GENEVE））netdev 设备

- l2tp

    二层隧道协议（Layer 2 Tunneling Protocol（L2TP））是一个用于支持虚拟私有网络（VPNs）或作为 ISPs 的分发网络的组成部分的隧道协议。它自身并不提供任何加密或验证。

- macsec

    媒体存取控制安全（Media Access Control Security（MACsec））是一个 *802.1AE IEEE* 工业标准安全技术，它提供了以太网链路上所有流量的安全交流。MACsec 提供了以太网链路上两个直连节点的点对点安全，并且可以分辨并阻止大多数安全威胁。

- vrf
    虚拟路由和转发（Virtual Routing and Forwarding（VRF））界面用于创建分离的路由和转发域。

-vcan

    虚拟 CAN 驱动器（virtual CAN driver（vcan））。与网络回环设备类似，vcan 提供一个虚拟的本地 CAN 界面。

- vxcan

    虚拟 CAN 隧道驱动器（virtual CAN tunnel driver（vxcan））。与虚拟以太网驱动器 veth 类似，vxcan 实现了一个在本地的两个虚拟 CAN 网路设备之间的 CAN 流量隧道。  
    当创建一个 vxcan 时，两个 vxcan 设备将作为配对设备被创建。当一端收到了包裹则它就出现在了它自己的配对上，同理反之。vxcam 可以被用于跨命名空间交流。|

- wireguard

    WireGuard Secure Network Tunnel

- netdevsim

    一个模拟器。它模拟网络设备用于特殊各种网络 API，在当前时间上，它特别专注于与硬件负载转移相关的界面。

- nlmon
    一个 Netlink 监控设备，当你想监视系统 Netlink 报文时就使用 nlmon 设备。

- fou

    Foo-over-UDP 隧道。

- xfrm

    与 vti/vti6 相似的虚拟隧道界面，但具有一些优势。

## `[Match]` 段选项

仅当 `[Match]` 段匹配上了当前的环境，或该段为空时，才创虚拟网络设备。接收下列键：

- `Host=`

    匹配主机的主机名或者机器 ID。  
    参见 *systemd.unit(5)* 中的 `ConditionHost=` 了解详情。  
    当前缀了一个感叹号 `!`，则结果取反。  
    若赋予了空字符串，那么前序赋予的值都被清除。

- `Virtualization=`

    检查系统是否在虚拟环境中运行，可选地检测它是否为特定地实现。  
    参见 *systemd.unit(5)* 中的 `ConditionVirtualization=` 了解详情。  
    当前缀了一个感叹号 `!`，则结果取反。  
    若赋予了空字符串，那么前序赋予的值都被清除。

- `KernelCommandLine=`

    检查是否设置了特定的内核命令行命令。  
    参见 *systemd.unit(5)* 中的 `ConditionKernelCommandLine=` 了解详情。  
    当前缀了一个感叹号 `!`，则结果取反。  
    若赋予了空字符串，那么前序赋予的值都被清除。

- `KernelVersion=`

    检查内核版本（同 `uname -r` 的返回值）匹配一个特定的表达式。  
    参见 *systemd.unit(5)* 中的 `ConditionKernelVersion=` 了解详情。  
    当前缀了一个感叹号 `!`，则结果取反。  
    若赋予了空字符串，那么前序赋予的值都被清除。

- `Architecture=`

    检查系统是否运行在特定的架构上。  
    参见 *systemd.unit(5)* 中的 `ConditionArchitecture=` 了解详情。  
    当前缀了一个感叹号 `!`，则结果取反。  
    若赋予了空字符串，那么前序赋予的值都被清除。

## `[NetDev]` 段选项

`[NetDev]` 段接收下列键：

- `Description=`

    无格式 netdev 描述。

- `Name=`

    当创建新 netdev 时所使用的界面名。该选项为必须项。

- `Kind=`

    netdev 的类型。该选项为必须项。  
    参见 [支持的 netdev 类型](#支持的%20netdev%20类型) 了解有效键值。

- `MTUBytes=`

    设置以字节为单位的该设备的最大传输单元。支持常见的后缀 `K` `M` `G`，以 **1024** 为底。  
    对于 `tun` 或者 `tap` 设备，当前并不支持在 `[NetDev]` 段为它们设置 `MTUBytes=`。请至对应的 *systemd.network(5)* 文件的 `[Link]` 段进行设置。

- `MACAddress=`

    该设备将使用的 MAC 地址。  
    对于 `tun` 或者 `tap` 设备，当前并不支持在 `[NetDev]` 段为它们设置 `MACAddress=`。请至对应的 *systemd.network(5)* 文件的 `[Link]` 段进行设置。  
    若该选项未设置，**vlan** 设备会继承其物理界面的 MAC 地址。对于其它类型的 netdev，若该选项未设置，则使用界面名和 *machine-id(5)* 生成 MAC 地址。

## `[Bridge]` 段选项

`[Bridge]` 段仅用于 **bridge** 类型的设备，接手下列键：

- `HelloTimeSec=`

    `HelloTimeSec` 指定了从根网桥（root bridge）和指定网桥（designated bridge）发出两个 hello 网络包的间隔。Hello 网络包用于在整个桥接的局域网网络中交流拓扑信息。

- `MaxAgeSec=`

    `MaxAgeSec` 指定了最大报文年龄（maximum message age）的秒数。若最后一次发现（接收）到 hello 网络包大于指定的秒数，则网桥开始接管过程，尝试将自身变成根网桥（Root Bridge）。

- `ForwardDelaySec=`

    `ForwardDelaySec` 指定了在转发（Forwarding）阶段前的，侦听与学习（Listening and Learning）阶段应该花费的秒数。

- `AgeingTimeSec=`

    指定接收到某 MAC 地址发来的网络包之后，该地址在转发数据库中保留的秒数。

- `Priority=`

    网桥的优先级。一个介于 `0` 至 `65535` 之间的整数。更小的数值表示更高的优先级。具有最低优先级的网桥将被选举为根网桥。

- `GroupForwardMask=`

    16-bit 位掩码表示的整数，允许具有 *802.1D* 保留地址（`01:80:C2:00:00:0X`）的本地帧被转发。将 位掩码 和 2^X 的幂进行逻辑与操作，X 为 MAC 地址最后的八进制数（octet）的低半字节（lower nibble）。
    举例来说，若值位 8，则允许转发地址为 **01:80:C2:00:00:03** 的帧（*802.1X PAE*）。

- `DefaultPVID=`

    为新加入的网桥端口指定默认的端口 VLAN IP。该值为介于 `1` 值 `4094` 之间的整型，或使用 `none` 关闭 PVID。

- `MulticastQuerier=`

    接受一个布尔值。该设置控制内核中的 **IFLA_BR_MCAST_QUERIER** 选项。  
    若开启，内核将从一个零源地址（zero source address）发送通用 ICMP 查询（general ICMP queries）。  
    该特性应该允许启动时更快地收敛（faster convergence），当也会导致一些多播察觉（multicast-aware）交换机的错误行为，并扰乱多播包的转发。  
    当未设置时，使用内核默认值。

- `MulticastSnooping=`

    接受一个布尔值。该设置控制内核中的 **IFLA_BR_MCAST_SNOOPING** 选项。  
    若启用，IGMP 嗅探 将监视 主机和多播路由之间的 因特网组管理协议（Internet Group Management Protocol（IGMP））。  
    当未设置时，使用内核默认值。

- `VLANFiltering=`

    接受一个布尔值。该设置控制内核中的 **IFLA_BR_VLAN_FILTERING** 选项。  
    若启用，网桥即以 **VLAN-filtering** 模式启用。  
    当未设置时，使用内核默认值。

- `STP=`

    接受一个布尔值。这启用了网桥的生成树协议（Spanning Tree Protocol（STP））。  
    当未设置时，使用内核默认值。

- `MulticastIGMPVersion=`

    允许修改网桥的 多播因特网组管理协议的版本。  
    接受 `2` 或者 `3`。  
    当未设置时，使用内核默认值。

## `[VLAN]` 段选项

`[VLAN]` 段仅用于 **vlan** 类型的设备，并接受下方键：

- `Id=`

    要使用的 VLAN ID。一个介于 `0` 至 `4094` 的整数。该选项为必须项。

- `GVRP=`

    接受一个布尔值。通用 VLAN 注册协议（Generic VLAN Registration Protocol（GVRP））是一个协议，允许在网络上自动学习 VLAN。  
    当未设置时，使用内核默认值。

- `MVRP=`

    接受一个布尔值。多重 VLAN 注册协议（Multiple VLAN Registration Protocol（MVRP）），以前也被称为 GARP VLAN Registration Protocol (GVRP)，是一个基于标准的二层网络协议，用于在交换机上自动配置 VLAN 信息。它在 *802.1Q-2005* 的改进版本 *802.1ak* 中定义。  
    当未设置时，使用内核默认值。

- `LooseBinding=`

    接受一个布尔值。VLAN 宽松绑定模式（loose binding mode），在该模式中，仅将作业状态（operational state）从父设备发送至关联的 VLANs，但 VLAN 设备状态并不改变。  
    当未设置时，使用内核默认值。

- `ReorderHeader=`

    接受一个布尔值。VLAN 重排序头部让 VLAN 界面的行为与物理界面相似。  
    当未设置时，使用内核默认值。

## `[MACVLAN]` 段选项

`[MACVLAN]` 段仅用于 **macvlan** 类型的设备，并接受下方键：

- `Mode=`

    要使用的 MACVLAN 模式。支持的选项有 `private` `vepa` `bridge` `passthru`。

## `[MACVTAP]` 段选项

`[MACVTAP]` 段仅用于 **macvtap** 类型的设备，键与 `[MACVLAN]` 相同。

## `[IPVLAN]` 段选项

`[IPVLAN]` 段仅用于 **ipvlan** 类型的设备，并接受下方键：

- `Mode=`

    要使用的 IPVLAN 模式。支持的模式为 `L2` `L3` 和 `L3S`。

- `Flags=`

    要使用的 IPVLAN flag。支持的选项为 `bridge` `private` `vepa`。

## `[IPVTAP]` 段选项

`[IPVTAP]` 段仅用于 **ipvtap** 类型的设备，键与 `[IPVLAN]` 相同。

## `[VXLAN]` 段选项

`[VXLAN]` 段仅作用于 `vxlan` 类型的设备，并接受下方键：

- `VNI=`

    VXLAN 网络标识符（或 VXLAN 段 ID）。接受一个介于 `1` 与 `16777215` 的数字。

- `Remote=`

    配置目标 IP 地址。

- `Local=`

    配置本地 IP 地址。

- `Group=`

    配置 VXLAN 多播组 IP 地址。所有属于同一个 VXLAN 的成员必须具有相同的多播组地址。

- `TOS=`

    vxlan 界面的 服务类型（Type Of Service）比特值。

- `TTL=`

    一个固定的 Time To Live N on Virtual eXtensible Local Area Network 包。接受 `inherit` 或介于 `0` - `255` 之间的值。`0` 是一个特殊值，表示继承内部协议的 TTL 值。`inherit` 意味着它将继承外部协议的 TTL 值。

- `MacLearning=`

    接受一个布尔值。若为真，启用动态 MAC 学习来发现远程 MAC 地址。

- `FDBAgeingSec=`

    从内核学习的转发数据库条目的生命周期（lifetime），以秒为单位。

- `MaximumFDBEntries=`

    配置最大 FDB 条目的最大数量。

- `ReduceARPProxy=`

    接受一个布尔值。若为真，网桥连接的 VXLAN 隧道终端从本地网桥回复 ARP 请求，代表了 Distributed Overlay Virtual Ethernet (DVOE) 客户端。默认为假。

- `L2MissNotification=`

    接受一个布尔值。若为真，启用 netlink LLADDR 丢失提示。

- `L3MissNotification=`

    接受一个布尔值。若为真，启用 netlink IP 地址丢失提示。

- `RouteShortCircuit=`

    接受一个布尔值，若为真，开启路由短路（route short circuiting）。

- `UDPChecksum=`

    接受一个布尔值。若为真，则在执行 VXLAN/IPv4 时进行 UDP 校验。

- `UDP6ZeroChecksumTx=`

    接受一个布尔值。若为真，开启在 VXLAN/IPv6 发送 零校验和（zero checksums）。

- `UDP6ZeroChecksumRx=`

    接受一个布尔值。若为真，开启在 VXLAN/IPv6 接收 零校验和（zero checksums）。

- `RemoteChecksumTx=`

    接受一个布尔值。若为真，启用 VXLAN 的远程传送校验负载转移。

- `RemoteChecksumRx=`

    接受一个布尔值。若为真，启用 VXLAN 的远程接收校验负载转移。

- `GroupPolicyExtension=`

    接受一个布尔值。若为真，它启用 基于 VXLAN 的跨网络对象（peer）的组策略 VXLAN 扩展安全标签机制。  
    有关组策略 VXLAN，参见 *VXLAN 组策略* 文档。  
    默认为假。

- `GenericProtocolExtension=`

    接受一个布尔值。若为真，通用协议扩展（Generic Protocol Extension）扩展现有的 VXLAN 协议来提供 typing，OAM 和 versioning 的能力。  
    要了解更多有关 VXLAN GPE Header 的信息，参见 *Generic Protocol for VXLAN* 文档。  
    若目标端口未设置，且设置了 Generic Protocol Extension，则默认使用端口 4790。  
    默认为假。

- `DestinationPort=`

    以每设备为基准，配置默认目标 UDP 端口。若未指定目标端口，那么使用 Linux 内核的默认值。设置目标端口 4789 来使用 IANA 分配的值。若未设置，或目标端口设置为空字符串，则将使用默认端口 4789。

- `PortRange=`

    配置 VXLAN 端口范围。VXLAN 基于源 UDP 端口基于流量，来帮助接收端能基于外部头流量的负载均衡。它限制了端口范围为普通 UDP 本地端口，并允许通过配置来覆盖。

- `FlowLabel=`

    指定发出网络包的流量标签。有效值为 `0` 至 `1048575`。

- `IPDoNotFragment=`

    允许设置发出网络包的 IPv4 不分段（Do not Fragment（DF））位，或从 IPv4 内部头继承值。  
    接受一个布尔值，或 `inherit`。  
    若封装协议为 `IPv6`，则设置为 `inherit`。  
    当未设置时，使用内核的默认设置。

## `[GENEVE]` 段选项

    `[GENEVE]` 段仅作用于 **geneve** 类型的设备，并接受下列键：

- `Id=`

    指定要使用的虚拟网络标识符（Virtual Network Identifier（VNI））。介于 `0` 至 `16777215`。该项为必须项。

- `Remote=`

    指定传出网络包的单播目标 IP 地址。

- `TOS=`

    指定传出网络包的 TOS 值。介于 `1` 至 `255`。

- `TTL=`

    接受与 `[VXLAN]` 段中的相同值，但若未设置，或者设置为 `0`，则使用内核默认值，也就是说网络包的 TTL 将从 `/proc/sys/net/ipv4/ip_default_ttl` 中获取。

- `UDPChecksum=`

    接受一个布尔值。若为真，则开启在 IPv4 上传送的 UDP 网络包的校验。

- `UDP6ZeroChecksumTx=`

    接受一个布尔值。若为真，则跳过 IPv6 上传送的 UDP 网络包的校验。

- `UDP6ZeroChecksumRx=`

    接受一个布尔值。若为真，则允许接收的 IPv6 UDP 网络包具有 零校验和字段。

- `DestinationPort=`

    指定目标端口。默认为 `6081`。若未设置，或赋予了空字符串，则使用默认的端口 `6081`。

- `FlowLabel=`

    指定发出的网络包的流标签。

- `IPDoNotFragment=`

    接受与 `[VXLAN]` 段相同的键。

## `[L2TP]` 段选项

`[L2TP]` 段仅作用于 **l2tp** 类型的设备，并接受下列键：

- `TunnelId=`

    指定隧道 ID。所使用的值必须匹配同伴的 `PeerTunelID=` 的值。是一个介于 `1` 至 `4294967295` 之间的数。该选项为必须项。

- `PeerTunnelId=`

    指定同伴（peer）隧道 ID。该值必须匹配同伴的 `TunnelID=` 值。是一个介于 `1` 至 `4294967295` 之间的数。该选项为必须项。

- `Remote=`

    指定远程同伴的 IP 地址。该选项为必须项。

- `Local=`

    指定本地界面的 IP 地址。接受一个 IP 地址，或特殊的 `auto` `static` `dynamic`。  
    当设置了一个地址，则本地界面必须具有该地址。  
    若设置为 `auto`，则使用本地界面所具有的一个地址。  
    相似的，若设置了 `static` 或 `dynamic`，则使用本地界面的某个静态或动态地址。  
    默认为 `auto`。

- `EncapsulationType=`

    指定隧道的封装类型。接受 `udp` 或者 `ip`。

- `UDPSourcePort=`

    指定隧道所使用的 UDP 源端口。若选择了 UDP 封装，则该项为必须项。若选择了 IP 封装，则该项被忽略。

- `DestinationPort=`

    指定目标端口。若选择了 UDP 封装，则该项为必须项。若选择了 IP 封装，则该项被忽略。

- `UDPChecksum=`

    接受一个布尔值。若为真，则开启在 IPv4 上传送的 UDP 网络包的校验。

- `UDP6ZeroChecksumTx=`

    接受一个布尔值。若为真，则跳过 IPv6 上传送的 UDP 网络包的校验。

- `UDP6ZeroChecksumRx=`

    接受一个布尔值。若为真，则允许接收的 IPv6 UDP 网络包具有 零校验和字段。

## `[L2TPSession]` 段选项

`[L2TPSession]` 段仅作用于 **l2tp** 类型的设备，并接受下方键：

- `Name=`

    指定会话的名称。该选项为必须项。

- `SessionId=`

    指定会话 ID。所使用的值必须匹配同伴的 `PeerSessionId=` 值。是一个介于 `1` 至 `4294967295` 之间的数。该选项为必须项。

- `PeerSessionId=`

    指定同伴会话 ID。所使用的值必须匹配同伴的 `SessionId=` 值。是一个介于 `1` 至 `4294967295` 之间的数。该选项为必须项。

- `Layer2SpecificHeader=`

    指定会话的二层特定头部。可以为 `none` 或 `default`。默认为 `default`。
